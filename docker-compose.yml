services:
  agent-memory:
    build:
      context: .
      dockerfile: Dockerfile
    image: agent-memory:latest
    container_name: agent-memory
    command: ['node', 'dist/cli.js', 'rest']
    ports:
      - '8787:8787'
    volumes:
      # Bind mount to shared data directory
      # Override AGENT_MEMORY_DATA_DIR to use a different host location
      # Note: "~" is not expanded by Docker Compose; prefer ${HOME}/... or set AGENT_MEMORY_DATA_DIR explicitly.
      - ${AGENT_MEMORY_DATA_DIR:-${HOME}/.agent-memory}:/data
    # Load environment variables from .env file (for non-path settings)
    env_file:
      - .env
    environment:
      # Container paths are hardcoded - do not read from .env
      # The bind mount maps host's ~/.agent-memory to container's /data
      - AGENT_MEMORY_DB_PATH=/data/memory.db
      - AGENT_MEMORY_VECTOR_DB_PATH=/data/vectors.lance
      # REST API
      - AGENT_MEMORY_REST_ENABLED=true
      - AGENT_MEMORY_REST_HOST=0.0.0.0
      - AGENT_MEMORY_REST_PORT=8787
      # Logging (can be overridden in .env)
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - AGENT_MEMORY_PERF=${AGENT_MEMORY_PERF:-0}

    # Restart policy
    restart: unless-stopped

    # Logging configuration
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'

    # Labels for organization
    labels:
      - 'com.agent-memory.version=0.9.2'
      - 'com.agent-memory.environment=production'

    # Optional: Resource limits
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '2'
    #       memory: 2G
    #     reservations:
    #       cpus: '1'
    #       memory: 512M

# Named volume (optional - only needed if not using shared bind mount)
# Uncomment to use isolated Docker volume instead of shared directory
# volumes:
#   agent-memory-data:
#     driver: local
